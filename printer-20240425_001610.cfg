#MAX3

# This file contains common pin mappings for MKS SKIPR b
# boards. To use this config, the firmware should be compiled for the
# stm32f407. When running "make menuconfig", select the 48KiB
# bootloader, and enable "Serial for communication" and select the "on USART1 PA10/PA9"

# The "make flash" command does not work on the MKS SKIPR. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "mks_skipr.bin" on an SD card and then restart the
# MKS SKIPR with that SD card.
# This file contains common pin mappings for MKS SKIPR
# boards. To use this config, the firmware should be compiled for the
# stm32f407. When running "make menuconfig", select the 48KiB
# bootloader, and enable "Serial for communication" and select the "on USART1 PA10/PA9"

# The "make flash" command does not work on the MKS SKIPR. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "mks_skipr.bin" on an SD card and then restart the
# MKS SKIPR with that SD card.

# See docs/Config_Reference.md for a description of parameters.

########################################
# Included Files
########################################
[include config_backup.cfg]
[include macros.cfg]
[include sensorless_homing.cfg]
[include variable.cfg]
[include timelapse.cfg]
[include K-ShakeTune/*.cfg]
[include klipperscreen_shutdown.cfg]
[include sfs.cfg]
[include cartographer.cfg]
#[include Line_Purge.cfg]

[exclude_object]

[gcode_arcs]
resolution: 1.0

[pause_resume]
[display_status]




####################Force_move##############################

[force_move]
enable_force_move : false   #if bed gets stuck at top and BL touch wont deploy make true and move bed down.



[input_shaper] 
shaper_freq_x: 58.2
shaper_type_x: mzv
shaper_freq_y: 43.4
shaper_type_y: mzv

[idle_timeout]
timeout: 5400

[virtual_sdcard]
path: /home/mks/printer_data/gcodes




[duplicate_pin_override]
pins: PA1,PC9
#   A comma separated list of pins that may be used multiple times in
#   a config file without normal error checks. This parameter must be
#   provided.

[pause_resume]
recover_velocity: 50.0


########################################
# Printer & MCU Settings
########################################

[mcu]
# The hardware use USART1 PA10/PA9 connect to RK3328
#serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_4D0045001850314335393520-if00
#canbus_uuid: 11aa22bb33cc
serial: /dev/ttyS0
restart_method: command

[mcu MKS_THR]
serial:/dev/serial/by-id/usb-Klipper_rp2040_45044E15377B6458-if00


[printer]
kinematics:corexy
max_velocity: 600
max_accel: 20000
#max_accel_to_decel: 10000 Depreciated
max_z_velocity: 10
max_z_accel: 500
square_corner_velocity: 8




########################################
# Input Shaper Settings 
########################################

##[adxl345] #Toolhead
##cs_pin: MKS_THR:gpio13
##spi_software_sclk_pin: MKS_THR:gpio14
##spi_software_mosi_pin: MKS_THR:gpio15
##spi_software_miso_pin: MKS_THR:gpio12
##axes_map: -x, z, -y

##[resonance_tester]
##accel_chip:adxl345
##probe_points:160, 160, 20  # an example
    #160, 160, 20  # an example
##min_freq: 30
##max_freq: 137

[lis2dw]
cs_pin: cartographer:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: lis2dw
probe_points:
    162, 162, 20
min_freq: 30
max_freq: 150


[gcode_macro SHAPER_CALIBRATE]
rename_existing: RESHAPER_CALIBRATE
gcode:
    RESHAPER_CALIBRATE FREQ_START=30 FREQ_END=150#########

########################################
# Extruder & Driver Settings
########################################


[extruder]
step_pin: MKS_THR:gpio5
dir_pin: MKS_THR:gpio4
enable_pin: !MKS_THR:gpio10
rotation_distance: 53.5  #22.6789511	#Bondtech 5mm Drive Gears
gear_ratio: 1628:170				
microsteps: 16
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
min_temp: 0
max_temp: 360
min_extrude_temp: 170
smooth_time: 0.000001


heater_pin: MKS_THR:gpio0
sensor_type:MAX6675
#   One of "MAX6675", "MAX31855", "MAX31856", or "MAX31865".
#   One of "MAX6675", "MAX31855", "MAX31856", or "MAX31865".
sensor_pin:MKS_THR:gpio17
#   The chip select line for the sensor chip. This parameter must be
#   provided.
spi_speed: 100000
#   The SPI speed (in hz) to use when communicating with the chip.
#   The default is 4000000.
#spi_bus:spi1
spi_software_sclk_pin:MKS_THR:gpio18
spi_software_mosi_pin:MKS_THR:gpio19
spi_software_miso_pin:MKS_THR:gpio16
#   See the "common SPI settings" section for a description of the
#   above parameters.
#tc_type: K
#tc_use_50Hz_filter: False
#c_averaging_count: 1
#   The above parameters control the sensor parameters of MAX31856
#   chips. The defaults for each parameter are next to the parameter
#   name in the above list.
max_power: 1.0
control : pid  
pid_Kp=14.734
pid_Ki=6.549 
pid_Kd=8.288

pressure_advance: 0.032
pressure_advance_smooth_time: 0.03
max_extrude_cross_section:500
instantaneous_corner_velocity: 10.000
max_extrude_only_distance: 100.0
max_extrude_only_velocity:5000
max_extrude_only_accel:2000
step_pulse_duration:0.000002


[tmc2209 extruder]
uart_pin: MKS_THR:gpio6
interpolate: True
run_current: 0.8
#hold_current: 0.5
#sense_resistor: 0.110
stealthchop_threshold: 0


########################################
# X Stepper Motor & Driver Settings
########################################

[stepper_x]
step_pin:PB4
dir_pin:PB3
enable_pin:!PB5
microsteps:16
rotation_distance: 39.94
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:tmc2209_stepper_x:virtual_endstop
position_min: -7
position_endstop:-7
position_max:325
homing_speed:40
homing_retract_dist:0
homing_positive_dir:False
step_pulse_duration:0.000002



[tmc2209 stepper_x]
uart_pin: PD2
run_current:1.07
#hold_current: 0.5
interpolate: True
stealthchop_threshold: 0
diag_pin:^PB8
driver_SGTHRS: 85
#driver_SGTHRS: 130

########################################
# Y Stepper Motor & Driver Settings
########################################


[stepper_y]
step_pin:PC14
dir_pin:PC13
enable_pin:!PC15
microsteps: 16
rotation_distance: 39.94
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:tmc2209_stepper_y:virtual_endstop
position_min: -10.5
position_endstop: -10.5
position_max: 325
homing_speed:40
homing_retract_dist:0
homing_positive_dir:False
step_pulse_duration:0.000002


[tmc2209 stepper_y]
uart_pin: PB9
run_current: 1.07
#hold_current: 0.5
interpolate: True
stealthchop_threshold: 0
diag_pin:^PC0
driver_SGTHRS: 85
#driver_SGTHRS: 145

########################################
# Z Stepper Motor & Driver Settings
########################################


[stepper_z]
step_pin:PC10
dir_pin:PA15
enable_pin: !PC11
microsteps: 16
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin:probe:z_virtual_endstop #!PC3 #for Z-max; endstop have'!' is NO
#position_endstop:326
position_max:325
position_min: -2
homing_speed: 10
homing_retract_dist: 8.0
second_homing_speed: 8
homing_positive_dir:false
step_pulse_duration:0.000002



[tmc2209 stepper_z]
uart_pin: PC5
run_current: 0.90
#hold_current: 0.6
interpolate: True
stealthchop_threshold: 999999




########################################
# Bed Settings
########################################


[heater_bed]
heater_pin:PC8
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA0
max_power: 1.0
control = pid
pid_kp = 71.039
pid_ki = 2.223
pid_kd = 567.421
min_temp: -50
max_temp: 125


########################################
# Temp Settings
########################################



[verify_heater chamber]
max_error: 120
check_gain_time:480
hysteresis: 5
heating_gain: 1



[verify_heater extruder]
max_error: 120
check_gain_time:20
hysteresis: 5
heating_gain: 1

[verify_heater heater_bed]
max_error: 120
check_gain_time:60
hysteresis: 5
heating_gain: 1

[temperature_sensor RPI]
sensor_type: rpi_temperature # alternate def
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu


[temperature_sensor host_temp]
sensor_type: temperature_host

##########################
#  Chamber, Fans & 
#############################

########CHAMBER#########
[heater_generic chamber]
#gcode_id:
#   使用M105查询温度时使用的ID。
#   必须提供此参数。
heater_pin:PB10
max_power:1.0
sensor_type:NTC 100K MGB18-104F39050L32
sensor_pin:PA1

control:pid
control = pid
pid_Kp=63.418 
pid_Ki=1.342 
pid_Kd=749.125

min_temp:-100
max_temp:70


#########Dual SIDE FAN FAN2#################
[output_pin fan2] #fan2
pin: PA8
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.00
scale: 255
shutdown_value: 0.0



##########CHAMBER FAN FAN################### 
[output_pin fan3]
pin:PC9
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.0
scale: 255
shutdown_value: 0.0

[temperature_fan chamber] #fan3
pin:PC9
max_power: 1
#-shutdown_speed:
#-cycle_time:
hardware_pwm: false
#-kick_start_time:
off_below:.1
#-   See the "fan" section in example.cfg for a description of the
#-   above parameters.
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA1
control : pid
pid_kp : 60
pid_ki : 1
pid_kd : 900
pid_deriv_time:120
min_temp:0
max_temp:90
#-   See the "extruder" section in example.cfg for a description of the
#-  above parameters.
target_temp: 50.0
#-   A temperature (in Celsius) that will be the target temperature.
#-  The default is 40 degrees.
max_speed: 1
min_speed: 0.0
gcode_id:hot


######## Hotend fan ###############
[heater_fan hotend_fan]
pin:MKS_THR:gpio1
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
fan_speed: 1.0
off_below: 0


########### PARTS FAN FAN0#############
[output_pin fan0]
pin: MKS_THR:gpio2
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0
scale: 255
shutdown_value: 0.0


#########Beeper##########
[output_pin beeper]
##  Chamber Lighting - In 5V-RGB Position
pin: PA2
pwm: false
shutdown_value:0
value:0

##############################
##   Bed mesh #### See cart cfg
##############################


##[bed_mesh]
##speed:150               
##horizontal_move_z:10   
##mesh_min:25,25        
##mesh_max:310,310      
##probe_count: 9,9      
##algorithm:bicubic
##bicubic_tension:0.2
##mesh_pps: 4, 4

##[bltouch]
##ensor_pin:^MKS_THR:gpio21
##control_pin:MKS_THR:gpio11
##stow_on_each_sample: False
#[probe]
#pin: ^!MKS_THR:gpio21
#x_offset: 28
#y_offset: 4.4
#z_offset: 0.0
#speed: 5
#samples: 3
#samples_result: average
#sample_retract_dist: 3.0
#samples_tolerance: 0.08
#samples_tolerance_retries:3








[respond]
#default_type: echo
#   Sets the default prefix of the "M118" and "RESPOND" output to one
#   of the following:
#       echo: "echo: " (This is the default)
#       command: "// "
#       error: "!! "
#default_prefix: echo:
#   Directly sets the default prefix. If present, this value will
#   override the "default_type".

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [cartographer model default]
#*# model_coef = 1.431289510785018,
#*# 	1.877886948597734,
#*# 	0.7167244141339496,
#*# 	0.20797530160194536,
#*# 	0.4745541768160871,
#*# 	0.7298763590396538,
#*# 	-0.40722892163789176,
#*# 	-0.772975893867612,
#*# 	0.33323880190227173,
#*# 	0.4073594610238116
#*# model_domain = 3.262608602965363e-07,3.36119117302499e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 43.632587
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.119292, -0.124551, -0.138545, -0.136132, -0.138568, -0.140965, -0.133561, -0.135475, -0.133737, -0.139728, -0.138603, -0.141950, -0.161492, -0.169274, -0.169903, -0.180030, -0.175707, -0.170026, -0.169999, -0.190934
#*# 	  -0.098050, -0.100845, -0.112215, -0.108794, -0.112186, -0.113962, -0.104793, -0.104670, -0.109900, -0.110660, -0.105260, -0.114806, -0.128632, -0.138364, -0.141114, -0.145818, -0.148239, -0.138430, -0.139192, -0.158395
#*# 	  -0.082748, -0.081799, -0.092344, -0.086006, -0.091624, -0.096667, -0.083935, -0.087022, -0.091109, -0.090701, -0.089577, -0.091989, -0.107176, -0.112093, -0.112824, -0.124109, -0.121830, -0.119226, -0.120486, -0.135872
#*# 	  -0.062488, -0.062923, -0.070872, -0.062928, -0.069324, -0.076327, -0.065097, -0.063676, -0.071140, -0.068372, -0.067192, -0.068458, -0.081066, -0.084553, -0.086286, -0.095911, -0.097902, -0.093547, -0.096151, -0.105848
#*# 	  -0.038737, -0.039229, -0.051118, -0.043445, -0.044118, -0.046575, -0.037885, -0.036797, -0.042041, -0.042625, -0.038969, -0.040485, -0.054353, -0.053251, -0.058713, -0.068655, -0.066611, -0.066931, -0.064828, -0.071544
#*# 	  -0.029806, -0.027090, -0.041575, -0.035789, -0.027725, -0.035584, -0.026468, -0.018281, -0.023134, -0.028173, -0.027218, -0.022913, -0.037188, -0.042132, -0.039089, -0.051504, -0.049963, -0.049732, -0.049196, -0.055575
#*# 	  -0.028880, -0.030153, -0.038120, -0.032077, -0.030001, -0.030614, -0.019726, -0.017242, -0.017402, -0.023219, -0.020837, -0.021970, -0.030078, -0.033182, -0.033276, -0.043218, -0.044906, -0.043936, -0.041302, -0.049392
#*# 	  -0.021313, -0.026508, -0.034633, -0.025439, -0.025919, -0.023409, -0.011498, -0.010316, -0.016233, -0.015113, -0.015299, -0.017558, -0.027655, -0.027848, -0.026605, -0.036748, -0.034869, -0.032312, -0.026865, -0.032928
#*# 	  -0.013941, -0.017360, -0.025729, -0.017967, -0.014309, -0.013861, 0.000090, 0.003426, -0.004800, -0.003081, -0.004116, -0.006261, -0.016225, -0.018979, -0.016261, -0.025278, -0.024998, -0.019035, -0.017532, -0.023050
#*# 	  -0.018479, -0.026003, -0.030595, -0.025583, -0.024915, -0.016446, -0.004497, 0.003287, 0.004371, -0.000670, -0.004980, -0.004553, -0.017306, -0.018560, -0.013285, -0.022215, -0.022529, -0.016793, -0.015912, -0.024975
#*# 	  -0.027609, -0.031388, -0.041649, -0.033988, -0.027318, -0.022584, -0.008855, 0.000854, 0.004298, -0.000035, -0.004844, -0.004710, -0.018156, -0.021292, -0.018543, -0.028634, -0.023089, -0.017472, -0.018310, -0.024914
#*# 	  -0.034623, -0.031819, -0.042520, -0.039120, -0.027696, -0.026932, -0.014827, -0.007035, -0.009740, -0.013117, -0.009395, -0.014014, -0.024774, -0.028020, -0.027658, -0.030468, -0.026542, -0.019426, -0.022730, -0.024399
#*# 	  -0.040583, -0.044056, -0.047352, -0.042443, -0.037537, -0.034210, -0.024457, -0.020900, -0.017533, -0.026804, -0.024849, -0.020769, -0.037928, -0.039845, -0.037190, -0.038038, -0.033718, -0.030192, -0.028265, -0.030476
#*# 	  -0.065840, -0.068140, -0.083628, -0.068665, -0.063615, -0.070129, -0.055120, -0.049791, -0.055206, -0.052456, -0.052421, -0.053763, -0.056601, -0.068037, -0.067266, -0.061481, -0.061040, -0.055809, -0.049198, -0.054678
#*# 	  -0.096605, -0.101172, -0.107375, -0.096776, -0.089591, -0.093634, -0.083067, -0.073931, -0.080836, -0.078918, -0.074146, -0.077543, -0.080980, -0.091339, -0.088305, -0.083636, -0.087190, -0.080087, -0.073623, -0.072909
#*# 	  -0.121260, -0.126647, -0.127729, -0.118234, -0.116992, -0.114501, -0.104500, -0.102806, -0.102505, -0.108363, -0.103369, -0.100481, -0.114374, -0.118179, -0.109304, -0.104966, -0.104423, -0.104819, -0.097808, -0.095140
#*# 	  -0.148529, -0.140551, -0.154307, -0.149110, -0.140949, -0.145199, -0.134038, -0.131589, -0.137963, -0.135982, -0.128843, -0.130116, -0.138055, -0.145799, -0.138789, -0.134105, -0.133273, -0.131297, -0.124959, -0.121083
#*# 	  -0.149461, -0.138426, -0.158377, -0.160320, -0.156909, -0.158016, -0.150105, -0.143646, -0.149661, -0.152067, -0.145734, -0.145683, -0.154587, -0.155563, -0.152007, -0.152658, -0.150496, -0.142175, -0.133422, -0.132875
#*# 	  -0.126565, -0.114725, -0.135803, -0.135990, -0.142201, -0.140819, -0.127649, -0.123920, -0.119242, -0.126560, -0.126769, -0.119287, -0.131341, -0.131447, -0.123800, -0.132474, -0.126127, -0.112757, -0.103525, -0.102130
#*# 	  -0.148398, -0.140974, -0.150660, -0.143538, -0.141193, -0.140984, -0.130434, -0.121684, -0.122326, -0.124084, -0.121643, -0.117121, -0.125813, -0.126708, -0.124128, -0.128551, -0.124078, -0.110784, -0.097835, -0.089882
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 310.0
#*# min_y = 25.0
#*# max_y = 310.0
