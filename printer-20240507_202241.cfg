#MAX3

# This file contains common pin mappings for MKS SKIPR b
# boards. To use this config, the firmware should be compiled for the
# stm32f407. When running "make menuconfig", select the 48KiB
# bootloader, and enable "Serial for communication" and select the "on USART1 PA10/PA9"

# The "make flash" command does not work on the MKS SKIPR. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "mks_skipr.bin" on an SD card and then restart the
# MKS SKIPR with that SD card.
# This file contains common pin mappings for MKS SKIPR
# boards. To use this config, the firmware should be compiled for the
# stm32f407. When running "make menuconfig", select the 48KiB
# bootloader, and enable "Serial for communication" and select the "on USART1 PA10/PA9"

# The "make flash" command does not work on the MKS SKIPR. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "mks_skipr.bin" on an SD card and then restart the
# MKS SKIPR with that SD card.

# See docs/Config_Reference.md for a description of parameters.

########################################
# Included Files
########################################
[include config_backup.cfg]
[include macros.cfg]
[include sensorless_homing.cfg]
[include variable.cfg]
[include timelapse.cfg]
[include K-ShakeTune/*.cfg]
[include klipperscreen_shutdown.cfg]
[include sfs.cfg]
[include cartographer.cfg]
#[include Line_Purge.cfg]

[exclude_object]

[gcode_arcs]
resolution: 1.0

[pause_resume]
[display_status]




####################Force_move##############################

[force_move]
enable_force_move : false   #if bed gets stuck at top and BL touch wont deploy make true and move bed down.



[input_shaper] 
shaper_freq_x: 55.0
shaper_type_x: mzv
shaper_freq_y: 45.4
shaper_type_y: zv

[idle_timeout]
timeout: 5400

[virtual_sdcard]
path: /home/mks/printer_data/gcodes




[duplicate_pin_override]
pins: PA1,PC9
#   A comma separated list of pins that may be used multiple times in
#   a config file without normal error checks. This parameter must be
#   provided.

[pause_resume]
recover_velocity: 50.0


########################################
# Printer & MCU Settings
########################################

[mcu]
# The hardware use USART1 PA10/PA9 connect to RK3328
#serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_4D0045001850314335393520-if00
#canbus_uuid: 11aa22bb33cc
serial: /dev/ttyS0
restart_method: command

[mcu MKS_THR]
serial:/dev/serial/by-id/usb-Klipper_rp2040_45044E15377B6458-if00


[printer]
kinematics:corexy
max_velocity: 600
max_accel: 20000
#max_accel_to_decel: 10000 Depreciated
max_z_velocity: 10
max_z_accel: 500
square_corner_velocity: 8




########################################
# Input Shaper Settings 
########################################

#[adxl345] #Toolhead
#cs_pin: MKS_THR:gpio13
#spi_software_sclk_pin: MKS_THR:gpio14
#spi_software_mosi_pin: MKS_THR:gpio15
#spi_software_miso_pin: MKS_THR:gpio12
#axes_map: -x, z, -y


[lis2dw]
cs_pin: cartographer:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: lis2dw
#accel_chip:adxl345
probe_points:
    162, 162, 20
min_freq: 30
max_freq: 150


[gcode_macro SHAPER_CALIBRATE]
rename_existing: RESHAPER_CALIBRATE
gcode:
    RESHAPER_CALIBRATE FREQ_START=30 FREQ_END=150#########

########################################
# Extruder & Driver Settings
########################################


[extruder]
step_pin: MKS_THR:gpio5
dir_pin: MKS_THR:gpio4
enable_pin: !MKS_THR:gpio10
rotation_distance: 53.5  #22.6789511	#Bondtech 5mm Drive Gears
gear_ratio: 1628:170				
microsteps: 16
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
min_temp: 0
max_temp: 360
min_extrude_temp: 170
smooth_time: 0.06


heater_pin: MKS_THR:gpio0
sensor_type:MAX6675
#   One of "MAX6675", "MAX31855", "MAX31856", or "MAX31865".
#   One of "MAX6675", "MAX31855", "MAX31856", or "MAX31865".
sensor_pin:MKS_THR:gpio17
#   The chip select line for the sensor chip. This parameter must be
#   provided.
spi_speed: 100000
#   The SPI speed (in hz) to use when communicating with the chip.
#   The default is 4000000.
#spi_bus:spi1
spi_software_sclk_pin:MKS_THR:gpio18
spi_software_mosi_pin:MKS_THR:gpio19
spi_software_miso_pin:MKS_THR:gpio16
#   See the "common SPI settings" section for a description of the
#   above parameters.
#tc_type: K
#tc_use_50Hz_filter: False
#c_averaging_count: 1
#   The above parameters control the sensor parameters of MAX31856
#   chips. The defaults for each parameter are next to the parameter
#   name in the above list.
max_power: 1.0
#control : pid  
#pid_Kp=14.734
#pid_Ki=6.549 
#pid_Kd=8.288

pressure_advance: 0.032
pressure_advance_smooth_time: 0.03
max_extrude_cross_section:500
instantaneous_corner_velocity: 10.000
max_extrude_only_distance: 100.0
max_extrude_only_velocity:5000
max_extrude_only_accel:2000
step_pulse_duration:0.000002


[tmc2209 extruder]
uart_pin: MKS_THR:gpio6
interpolate: True
run_current: 0.8
#hold_current: 0.5
#sense_resistor: 0.110
stealthchop_threshold: 0


########################################
# X Stepper Motor & Driver Settings
########################################

[stepper_x]
step_pin:PB4
dir_pin:PB3
enable_pin:!PB5
microsteps:16
rotation_distance: 39.94
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:tmc2209_stepper_x:virtual_endstop
position_min: -7
position_endstop:-7
position_max:325
homing_speed:40
homing_retract_dist:0
homing_positive_dir:False





[tmc2209 stepper_x]
uart_pin: PD2
run_current:1.07
#hold_current: 0.5
interpolate: True
stealthchop_threshold: 0
diag_pin:^PB8
driver_SGTHRS: 85
#driver_SGTHRS: 130

########################################
# Y Stepper Motor & Driver Settings
########################################


[stepper_y]
step_pin:PC14
dir_pin:PC13
enable_pin:!PC15
microsteps: 16
rotation_distance: 39.94
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:tmc2209_stepper_y:virtual_endstop
position_min: -10.5
position_endstop: -10.5
position_max: 325
homing_speed:40
homing_retract_dist:0
homing_positive_dir:False




[tmc2209 stepper_y]
uart_pin: PB9
run_current: 1.07
#hold_current: 0.5
interpolate: True
stealthchop_threshold: 0
diag_pin:^PC0
driver_SGTHRS: 110
#driver_SGTHRS: 145

########################################
# Z Stepper Motor & Driver Settings
########################################


[stepper_z]
step_pin:PC10
dir_pin:PA15
enable_pin: !PC11
microsteps: 16
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin:probe:z_virtual_endstop #!PC3 #for Z-max; endstop have'!' is NO
#position_endstop:326
position_max:325
position_min: -2
homing_speed: 10
homing_retract_dist: 0 # cartographer needs this to be set to 0 default #8.0
second_homing_speed: 8
homing_positive_dir:false





[tmc2209 stepper_z]
uart_pin: PC5
run_current: 0.90
#hold_current: 0.6
interpolate: True
stealthchop_threshold: 999999




########################################
# Bed Settings
########################################


[heater_bed]
heater_pin:PC8
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA0
max_power: 1.0
control = pid
pid_kp = 71.039
pid_ki = 2.223
pid_kd = 567.421
min_temp: -50
max_temp: 125


########################################
# Temp Settings
########################################



[verify_heater chamber_heater]
max_error: 120
check_gain_time:480
hysteresis: 5
heating_gain: 1



[verify_heater extruder]
max_error: 120
check_gain_time:20
hysteresis: 5
heating_gain: 1

[verify_heater heater_bed]
max_error: 120
check_gain_time:60
hysteresis: 5
heating_gain: 1

[temperature_sensor RPI]
sensor_type: rpi_temperature # alternate def
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu


[temperature_sensor host_temp]
sensor_type: temperature_host

##########################
#  Chamber, Fans & 
#############################

########CHAMBER#########
[heater_generic chamber_heater]
heater_pin:PB10
max_power:1.0
sensor_type:NTC 100K MGB18-104F39050L32
sensor_pin:PA1
control:pid
control = pid
pid_Kp=63.418 
pid_Ki=1.342 
pid_Kd=749.125
min_temp:0
max_temp:70


#########Dual SIDE FAN FAN2#################
[output_pin fan2] #fan2
pin: PA8
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.00
scale: 255
shutdown_value: 0.0



##########CHAMBER FAN FAN################### 
[output_pin fan3]
pin:PC9
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.0
scale: 255
shutdown_value: 0.0

[temperature_fan chamber_fan] #fan3
pin:PC9
max_power: 1
#-shutdown_speed:
#-cycle_time:
hardware_pwm: false
#-kick_start_time:
off_below:.1
#-   See the "fan" section in example.cfg for a description of the
#-   above parameters.
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA1
control : pid
pid_kp : 60
pid_ki : 1
pid_kd : 900
pid_deriv_time:120
min_temp:0
max_temp:90
#-   See the "extruder" section in example.cfg for a description of the
#-  above parameters.
target_temp: 50.0
#-   A temperature (in Celsius) that will be the target temperature.
#-  The default is 40 degrees.
max_speed: 1
min_speed: 0.0



######## Hotend fan ###############
[heater_fan hotend_fan]
pin:MKS_THR:gpio1
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
fan_speed: 1.0
off_below: 0


########### PARTS FAN FAN0#############
[output_pin fan0]
pin: MKS_THR:gpio2
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0
scale: 255
shutdown_value: 0.0


#########Beeper##########
[output_pin beeper]
##  Chamber Lighting - In 5V-RGB Position
pin: PA2
pwm: false
shutdown_value:0
value:0

##############################
##   Bed mesh #### See cart cfg
##############################


##[bed_mesh]
##speed:150               
##horizontal_move_z:10   
##mesh_min:25,25        
##mesh_max:310,310      
##probe_count: 9,9      
##algorithm:bicubic
##bicubic_tension:0.2
##mesh_pps: 4, 4

##[bltouch]
##ensor_pin:^MKS_THR:gpio21
##control_pin:MKS_THR:gpio11
##stow_on_each_sample: False
#[probe]
#pin: ^!MKS_THR:gpio21
#x_offset: 28
#y_offset: 4.4
#z_offset: 0.0
#speed: 5
#samples: 3
#samples_result: average
#sample_retract_dist: 3.0
#samples_tolerance: 0.08
#samples_tolerance_retries:3








[respond]
#default_type: echo
#   Sets the default prefix of the "M118" and "RESPOND" output to one
#   of the following:
#       echo: "echo: " (This is the default)
#       command: "// "
#       error: "!! "
#default_prefix: echo:
#   Directly sets the default prefix. If present, this value will
#   override the "default_type".

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [cartographer model default]
#*# model_coef = 1.431289510785018,
#*# 	1.877886948597734,
#*# 	0.7167244141339496,
#*# 	0.20797530160194536,
#*# 	0.4745541768160871,
#*# 	0.7298763590396538,
#*# 	-0.40722892163789176,
#*# 	-0.772975893867612,
#*# 	0.33323880190227173,
#*# 	0.4073594610238116
#*# model_domain = 3.262608602965363e-07,3.36119117302499e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 43.632587
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.006522, 0.002245, -0.012193, -0.011183, -0.011903, -0.014056, -0.004796, -0.008250, -0.009293, -0.011375, -0.009252, -0.011693, -0.029699, -0.041626, -0.041252, -0.049844, -0.050521, -0.047269, -0.043891, -0.058442
#*# 	0.038942, 0.037793, 0.024272, 0.025220, 0.024100, 0.022229, 0.030523, 0.026559, 0.019666, 0.018791, 0.021830, 0.017897, 0.001387, -0.007169, -0.008243, -0.016577, -0.017717, -0.011365, -0.012830, -0.025731
#*# 	0.013265, 0.012185, -0.002240, 0.000864, -0.001295, -0.007149, -0.003072, -0.000604, -0.010833, -0.016272, -0.008223, -0.012928, -0.027475, -0.030033, -0.033459, -0.043600, -0.041357, -0.039102, -0.040981, -0.052511
#*# 	-0.025210, -0.023787, -0.034484, -0.029338, -0.031148, -0.038693, -0.031263, -0.034669, -0.041481, -0.040178, -0.039257, -0.040338, -0.052370, -0.057837, -0.059875, -0.067277, -0.069513, -0.066677, -0.069316, -0.080014
#*# 	-0.023735, -0.024420, -0.036699, -0.030003, -0.028989, -0.032574, -0.024745, -0.023299, -0.029769, -0.029977, -0.027298, -0.027980, -0.043372, -0.043260, -0.046800, -0.057860, -0.056191, -0.056126, -0.057369, -0.062906
#*# 	-0.015552, -0.018750, -0.028994, -0.022233, -0.021099, -0.024151, -0.013931, -0.012441, -0.017500, -0.016403, -0.019474, -0.015458, -0.028008, -0.032212, -0.033174, -0.043734, -0.042243, -0.040372, -0.039919, -0.047226
#*# 	-0.016548, -0.021041, -0.027320, -0.022102, -0.020961, -0.022983, -0.012213, -0.009819, -0.010589, -0.016303, -0.015700, -0.016126, -0.025212, -0.027962, -0.029624, -0.039154, -0.040533, -0.039026, -0.036448, -0.042068
#*# 	-0.007538, -0.013636, -0.020944, -0.014481, -0.014193, -0.013600, -0.000458, -0.000460, -0.005758, -0.007260, -0.006165, -0.006974, -0.020531, -0.020713, -0.017751, -0.030570, -0.027949, -0.024919, -0.022695, -0.024898
#*# 	-0.000281, -0.004839, -0.011961, -0.006487, -0.004159, -0.003231, 0.008883, 0.012483, 0.004497, 0.005243, 0.004286, 0.003061, -0.008148, -0.009756, -0.006333, -0.014412, -0.016176, -0.011117, -0.011589, -0.014207
#*# 	-0.005336, -0.012522, -0.019807, -0.016218, -0.014261, -0.007978, 0.002684, 0.011724, 0.009636, 0.006254, 0.002535, -0.001117, -0.012674, -0.012583, -0.011023, -0.018424, -0.017504, -0.013945, -0.011797, -0.018709
#*# 	-0.015552, -0.020409, -0.030292, -0.024248, -0.020279, -0.014646, -0.002245, 0.007066, 0.010625, 0.007705, 0.000022, 0.000702, -0.011304, -0.016195, -0.011996, -0.021822, -0.016817, -0.009705, -0.012818, -0.016884
#*# 	-0.018700, -0.020873, -0.028565, -0.027443, -0.017408, -0.017961, -0.006418, -0.003656, -0.001611, -0.003636, -0.005612, -0.006240, -0.016960, -0.023900, -0.021716, -0.021036, -0.020712, -0.012354, -0.014434, -0.019884
#*# 	-0.027282, -0.032319, -0.034500, -0.031787, -0.026495, -0.025449, -0.015898, -0.010506, -0.011421, -0.017098, -0.013976, -0.015348, -0.028262, -0.031631, -0.028327, -0.027589, -0.022729, -0.020807, -0.019383, -0.022533
#*# 	-0.050613, -0.051997, -0.063045, -0.054779, -0.049054, -0.052389, -0.040901, -0.036798, -0.038054, -0.042603, -0.040345, -0.036034, -0.048340, -0.055065, -0.051415, -0.053170, -0.047787, -0.043059, -0.041046, -0.042603
#*# 	-0.072296, -0.075191, -0.077285, -0.071849, -0.064264, -0.064555, -0.056654, -0.049704, -0.053181, -0.055730, -0.048267, -0.046657, -0.057774, -0.064855, -0.062462, -0.063327, -0.061573, -0.055321, -0.053168, -0.054351
#*# 	-0.049660, -0.049636, -0.054406, -0.044156, -0.042147, -0.039970, -0.032060, -0.031881, -0.030422, -0.032203, -0.025478, -0.024183, -0.038539, -0.041366, -0.037020, -0.037750, -0.033546, -0.034063, -0.031878, -0.034419
#*# 	-0.004622, -0.007735, -0.024280, -0.016297, -0.012757, -0.018525, -0.003184, -0.005763, -0.012149, -0.004848, -0.003581, 0.000034, -0.013327, -0.018545, -0.010696, -0.016214, -0.013404, -0.007105, -0.004826, -0.002947
#*# 	0.029790, 0.003987, -0.022453, -0.031047, -0.039484, -0.033630, -0.023709, -0.026614, -0.026187, -0.027140, -0.023342, -0.022047, -0.030098, -0.030848, -0.028368, -0.031553, -0.031048, -0.018564, -0.010525, -0.009569
#*# 	0.063340, 0.014630, -0.042092, -0.058707, -0.067761, -0.069230, -0.055545, -0.053179, -0.052699, -0.055478, -0.055377, -0.049692, -0.058062, -0.057674, -0.052395, -0.059813, -0.053324, -0.044969, -0.032904, -0.036890
#*# 	0.053337, -0.022334, -0.080497, -0.099020, -0.099113, -0.099909, -0.092404, -0.082249, -0.085855, -0.087497, -0.085935, -0.080154, -0.085940, -0.090720, -0.083671, -0.088000, -0.082257, -0.072489, -0.060571, -0.062394
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 310.0
#*# min_y = 25.0
#*# max_y = 310.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 43.290
#*# pid_ki = 4.976
#*# pid_kd = 94.155
#*# model_coef = 1.4170502716146232,
#*# 	  1.862153348062918,
#*# 	  0.7368756601482028,
#*# 	  0.1745762592306983,
#*# 	  0.40937326333230745,
#*# 	  0.9020202203424489,
#*# 	  -0.33878468059475086,
#*# 	  -1.0485486121867709,
#*# 	  0.3255918992817551,
#*# 	  0.5615253220921523
#*# model_domain = 3.2524765218892195e-07,3.3590600343013334e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 31.113246
#*# model_offset = 0.00000

